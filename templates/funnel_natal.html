<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Natal Logcomex 2025</title>
    <link rel="icon" type="image/x-icon" href="/static/img/favicon.ico">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6613D0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Natal Logcomex">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/img/icon-192.png">
    
    <link rel="stylesheet" href="/static/css/funnel.css">
    <link rel="stylesheet" href="/static/css/deal_celebration.css">
    <link rel="stylesheet" href="/static/css/deal_celebration_themes.css">
    <link rel="stylesheet" href="/static/css/top_evs_ranking.css">
    <link rel="stylesheet" href="/static/css/snow.css">
    <link rel="stylesheet" href="/static/css/christmas-tree.css">
    <link rel="stylesheet" href="/static/css/progress-bar-natal.css">
    <link rel="stylesheet" href="/static/css/carolina-dance.css">
    <link rel="stylesheet" href="/static/css/funnel-natal.css">
    <svg width="0" height="0" style="position: absolute;">
        <defs>
            <filter id="chromakey" x="0" y="0" width="100%" height="100%">
                <!-- Remove fundo verde (chroma key) -->
                <feColorMatrix type="matrix" 
                    values="1 0 0 0 0
                            0 1.5 0 0 0
                            0 0 1 0 0
                            0 0 0 1 0"/>
                <feComponentTransfer>
                    <feFuncA type="discrete" tableValues="0 1"/>
                </feComponentTransfer>
            </filter>
            <!-- Filtro chromakey melhorado para remover fundo verde -->
            <filter id="chromakey-green" x="-50%" y="-50%" width="200%" height="200%">
                <!-- Detecta e remove verdes (chroma key) -->
                <feColorMatrix type="matrix" 
                    values="1 0 0 0 0
                            0 1 0 0 0
                            0 0 1 0 0
                            0 0 0 1 0"/>
                <!-- Remove pixels verdes tornando-os transparentes -->
                <feColorMatrix type="matrix" 
                    values="1 0 0 0 0
                            0 1 0 0 0
                            0 0 1 0 0
                            -0.5 1.5 -0.5 0 0"/>
                <feComponentTransfer>
                    <feFuncA type="discrete" tableValues="0 1"/>
                </feComponentTransfer>
            </filter>
        </defs>
    </svg>
    <link rel="stylesheet" href="/static/css/home-button.css">
</head>
<body>
    <a href="/" class="home-button" title="Voltar para p√°gina inicial">üè†</a>
    <img src="/static/img/confidencial.png" alt="Confidencial" class="confidencial-logo">
    <div class="meta-title-natal">Meta de Dezembro</div>
    <div class="funnel-main-value funnel-main-value-natal" id="mainValue">R$ 739.014,83</div>
    
    <!-- Bot√µes de Teste -->
    <button id="testMilestoneBtn" class="test-milestone-btn" title="Testar anima√ß√£o dos marcos">
        üéØ
    </button>
    <button id="testDealCelebrationBtn" class="test-deal-celebration-btn" title="Testar celebra√ß√£o de deal" style="display: none;">
        üéâ
    </button>
    
    <!-- Bot√£o de Configura√ß√µes (Modo Manual) -->
    <button id="settingsBtn" class="settings-btn" title="Configura√ß√µes de faturamento">
        ‚öôÔ∏è
    </button>
    
    <!-- Menu Suspenso de Configura√ß√µes -->
    <div id="settingsMenu" class="settings-menu" style="display: none;">
        <div class="settings-menu-header">
            <h3>Configura√ß√µes de Faturamento</h3>
            <button id="closeSettingsBtn" class="close-settings-btn">√ó</button>
        </div>
        <div class="settings-menu-content">
            <div class="settings-toggle">
                <label class="toggle-switch">
                    <input type="checkbox" id="manualModeToggle">
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label">Modo Manual</span>
            </div>
            <div id="manualModeSettings" class="manual-mode-settings" style="display: none;">
                <label for="additionalValue">Valor Adicional (R$):</label>
                <input type="number" id="additionalValue" min="0" step="1000" placeholder="0" value="0">
                <p class="settings-hint">Este valor ser√° somado ao faturamento da API</p>
            </div>
            <div class="settings-toggle">
                <label class="toggle-switch">
                    <input type="checkbox" id="renewalPipelineToggle">
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label">Pipeline Renova√ß√£o</span>
            </div>
            <p class="settings-hint" style="margin-top: -15px; margin-bottom: 0;">Inclui receita do pipeline de Renova√ß√£o (7075777) no faturamento</p>
            
            <!-- Seletor de Tema de Celebra√ß√£o -->
            <div class="settings-section" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid rgba(255, 255, 255, 0.2);">
                <label for="celebrationThemeSelect" style="color: #fff; font-weight: 600; margin-bottom: 10px; display: block;">Tema de Celebra√ß√£o:</label>
                <select id="celebrationThemeSelect" class="theme-select">
                    <option value="black-november">Black November</option>
                    <option value="natal">Natal</option>
                </select>
                <p class="settings-hint" style="margin-top: 8px; margin-bottom: 0;">Escolha o tema visual para as celebra√ß√µes de deals</p>
            </div>
        </div>
    </div>

    <!-- Componente Universal de Celebra√ß√£o -->
    {% include 'includes/celebration_component.html' %}
    
    <!-- Carolina - Foto e V√≠deos de Dan√ßa -->
    <img src="/static/img/natal/carolina_feja.png" alt="Carolina" class="carolina-dance" id="carolinaImage">
    <video id="carolinaVideo1" class="carolina-dance" style="display: none;" preload="auto" muted>
        <source src="/static/img/natal/carol_natal.mp4" type="video/mp4">
    </video>
    <video id="carolinaVideo2" class="carolina-dance" style="display: none;" preload="auto" muted>
        <source src="/static/img/natal/carol_natal1.mp4" type="video/mp4">
    </video>
    <video id="carolinaVideo3" class="carolina-dance" style="display: none;" preload="auto" muted>
        <source src="/static/img/natal/carol_natal2.mp4" type="video/mp4">
    </video>
    <canvas id="carolinaVideoCanvas" class="carolina-dance" style="display: none;"></canvas>
    
    <!-- √Årvore de Natal -->
    <img src="/static/img/arvore_natal.png" alt="√Årvore de Natal" class="christmas-tree" id="christmasTree">
    
    <!-- Barra de Progresso Tem√°tica de Natal -->
    <div class="progress-container" id="progressContainer" style="display: none;">
        <div class="progress-wrapper">
            <div class="progress-label">
                <span id="progressText">R$ 0,00</span>
                <span class="progress-percentage" id="progressPercentage">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressBarFill"></div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="funnel-container">
            <div class="current-revenue" id="currentRevenue" style="display: none;"></div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>Carregando dados...</div>
            </div>
            
            <!-- Funil visual removido - apenas estrutura b√°sica mantida -->
            
            <div class="current-value-indicator" id="currentIndicator" style="display: none;"></div>
            <svg class="value-connection-line" id="connectionLine" style="display: none;">
                <line id="connectionLinePath" x1="0" y1="0" x2="0" y2="0" stroke="white" stroke-width="2" opacity="0.9"/>
            </svg>
            
            <div class="speech-bubble" id="speechBubble" style="display: none;">
                <span class="speech-text" id="speechText">MA√îEEEEEE</span>
            </div>
        </div>
    </div>

    <script src="/static/javascript/celebration_theme_manager.js"></script>
    <script src="/static/javascript/deal_celebration.js"></script>
    <script src="/static/javascript/snow.js"></script>
    <script src="/static/javascript/christmas-tree.js"></script>
    <script src="/static/javascript/carolina-dance.js"></script>
    <script src="/static/javascript/funnel_natal.js"></script>
    
    <!-- PWA Service Worker Registration e Notifica√ß√µes Push -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    // Registra o Service Worker
                    const registration = await navigator.serviceWorker.register('/static/service-worker.js');
                    console.log('Service Worker registrado com sucesso:', registration.scope);
                    
                    // Verifica se o navegador suporta notifica√ß√µes
                    if (!('Notification' in window)) {
                        console.warn('‚ùå Este navegador n√£o suporta notifica√ß√µes');
                        return;
                    }
                    
                    console.log('üì± Status de notifica√ß√£o atual:', Notification.permission);
                    
                    // Aguarda 3 segundos e solicita permiss√£o de notifica√ß√£o
                    setTimeout(async () => {
                        try {
                            if (Notification.permission === 'default') {
                                console.log('üîî Solicitando permiss√£o de notifica√ß√£o...');
                                const permission = await Notification.requestPermission();
                                console.log('üìã Resposta da permiss√£o:', permission);
                                
                                if (permission === 'granted') {
                                    console.log('‚úÖ Permiss√£o de notifica√ß√£o concedida!');
                                    // Mostra uma notifica√ß√£o de teste para confirmar que funciona
                                    registration.showNotification('Notifica√ß√µes Ativadas! üéâ', {
                                        body: 'Voc√™ receber√° notifica√ß√µes de novos deals ganhos!',
                                        icon: '/static/img/icon-192.png',
                                        badge: '/static/img/icon-192.png',
                                        tag: 'welcome',
                                        requireInteraction: false,
                                        vibrate: [200, 100, 200]
                                    });
                                } else if (permission === 'denied') {
                                    console.log('‚ùå Permiss√£o de notifica√ß√£o negada pelo usu√°rio');
                                } else {
                                    console.log('‚ö†Ô∏è Permiss√£o de notifica√ß√£o ignorada/fechada');
                                }
                            } else if (Notification.permission === 'granted') {
                                console.log('‚úÖ Permiss√£o de notifica√ß√£o j√° concedida anteriormente');
                                // Mostra notifica√ß√£o de boas-vindas mesmo se j√° tiver permiss√£o
                                registration.showNotification('Bem-vindo! üéâ', {
                                    body: 'Notifica√ß√µes est√£o ativas para novos deals!',
                                    icon: '/static/img/icon-192.png',
                                    tag: 'welcome-back',
                                    requireInteraction: false
                                });
                            } else if (Notification.permission === 'denied') {
                                console.log('‚ùå Permiss√£o de notifica√ß√£o foi negada anteriormente');
                                console.log('üí° Para ativar: Clique no √≠cone de cadeado na barra de endere√ßo > Configura√ß√µes do site > Notifica√ß√µes > Permitir');
                            }
                        } catch (error) {
                            console.error('‚ùå Erro ao solicitar permiss√£o de notifica√ß√£o:', error);
                        }
                    }, 3000);
                } catch (error) {
                    console.log('Falha ao registrar Service Worker:', error);
                }
            });
        } else {
            console.warn('‚ùå Service Worker n√£o √© suportado neste navegador');
        }
    </script>
    
    <!-- Sistema de Rota√ß√£o Autom√°tica -->
    <script>
        // Verifica se est√° no modo de rota√ß√£o autom√°tica
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('aleatorio')) {
            // Tenta desbloquear √°udio automaticamente no modo aleat√≥rio
            // Navegadores permitem autoplay quando vem de navega√ß√£o program√°tica
            window.addEventListener('load', () => {
                const audioElements = [
                    document.getElementById('cornetAudio')
                ];
                
                audioElements.forEach(audio => {
                    if (audio) {
                        audio.volume = 0.01; // Volume muito baixo
                        const playPromise = audio.play();
                        if (playPromise !== undefined) {
                            playPromise.then(() => {
                                audio.pause();
                                audio.currentTime = 0;
                                audio.volume = 1.0; // Restaura volume
                                console.log('‚úÖ √Åudio desbloqueado automaticamente:', audio.id);
                            }).catch(err => {
                                console.log('‚ö†Ô∏è √Åudio n√£o desbloqueado automaticamente (normal):', audio.id);
                            });
                        }
                    }
                });
            });
            
            // Timer de navega√ß√£o autom√°tica
        }
    </script>

    <!-- Twemoji para emojis consistentes -->
    <script src="https://unpkg.com/twemoji@latest/dist/twemoji.min.js" crossorigin="anonymous"></script>
    <script>
        // Aplica Twemoji assim que a p√°gina carregar
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üé® Aplicando Twemoji...');
            if (typeof twemoji !== 'undefined') {
                twemoji.parse(document.body, {
                    base: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/'
                });
                console.log('‚úÖ Twemoji aplicado com sucesso!');
            } else {
                console.error('‚ùå Twemoji n√£o carregado!');
            }
        });
    </script>
</body>
</html>
